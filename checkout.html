<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div style="text-align:center; padding-top:50px;">
        <h2>Processing Payment...</h2>
        <div id="loader" class="loader"></div>
    </div>

    <script type="module">
        import { db, auth } from './js/firebase.js';
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getCart } from './js/cart.js';
        import { checkAuth } from './js/auth.js';

        checkAuth(async (user) => {
            if(!user) {
                alert("Please login first");
                window.location.href = 'login.html';
                return;
            }

            const cart = getCart();
            if(cart.length === 0) return window.location.href = 'index.html';

            const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);

            try {
                // WRITE ORDER TO FIRESTORE
                await addDoc(collection(db, "orders"), {
                    userId: user.uid,
                    userEmail: user.email,
                    items: cart,
                    total: total,
                    status: "Pending", // Admin will change this later
                    createdAt: serverTimestamp()
                });

                // Clear Cart
                localStorage.removeItem('cart');
                alert("Order Placed Successfully!");
                window.location.href = 'orders.html';

            } catch (e) {
                alert("Error placing order: " + e.message);
                window.location.href = 'cart.html';
            }
        });
    </script>
</body>
</html>
